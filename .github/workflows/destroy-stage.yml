name: Destroy CallData Foundation Platform (Stage)

on:
  workflow_dispatch:
    inputs:
      confirm_destroy:
        description: 'Type "destroy" to confirm destruction of stage environment'
        required: true
        type: string

env:
  AWS_REGION: us-east-2
  TF_VERSION: 1.5.0

jobs:
  validate-destroy:
    name: Validate Destroy Request
    runs-on: ubuntu-latest
    steps:
      - name: Check Confirmation
        run: |
          if [ "${{ inputs.confirm_destroy }}" != "destroy" ]; then
            echo "::error::You must type 'destroy' to confirm destruction!"
            exit 1
          fi

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    needs: validate-destroy

    defaults:
      run:
        working-directory: terraform/environments/stage

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Destroy
        run: terraform destroy -auto-approve

      - name: Clean up orphaned resources
        run: |
          echo "Post-destroy cleanup..."

          for PROFILE_NAME in "calldata-foundation-stage-foundation-profile"; do
            for ROLE_NAME in "calldata-foundation-stage-foundation-ssm-role"; do
              aws iam remove-role-from-instance-profile --instance-profile-name $PROFILE_NAME --role-name $ROLE_NAME 2>/dev/null || true
            done
            aws iam delete-instance-profile --instance-profile-name $PROFILE_NAME 2>/dev/null || true
          done

          for ROLE_NAME in "calldata-foundation-stage-foundation-ssm-role"; do
            aws iam list-role-policies --role-name $ROLE_NAME 2>/dev/null | jq -r '.PolicyNames[]' | \
              xargs -I {} aws iam delete-role-policy --role-name $ROLE_NAME --policy-name {} 2>/dev/null || true
            aws iam list-attached-role-policies --role-name $ROLE_NAME 2>/dev/null | jq -r '.AttachedPolicies[].PolicyArn' | \
              xargs -I {} aws iam detach-role-policy --role-name $ROLE_NAME --policy-arn {} 2>/dev/null || true
            aws iam delete-role --role-name $ROLE_NAME 2>/dev/null || true
          done

          for BUCKET_NAME in "calldata-foundation-stage-ssm-logs"; do
            if aws s3api head-bucket --bucket $BUCKET_NAME --region ${{ env.AWS_REGION }} 2>/dev/null; then
              aws s3 rm s3://$BUCKET_NAME --recursive --region ${{ env.AWS_REGION }} 2>/dev/null || true
              aws s3api delete-bucket --bucket $BUCKET_NAME --region ${{ env.AWS_REGION }} 2>/dev/null || true
            fi
          done
        continue-on-error: true

  destroy-summary:
    name: Destroy Summary
    runs-on: ubuntu-latest
    needs: terraform-destroy
    if: always()

    steps:
      - name: Destroy Status
        run: |
          echo "=================================================="
          echo "CallData Foundation Platform (Stage) Destroy"
          echo "=================================================="
          echo "Terraform Destroy: ${{ needs.terraform-destroy.result }}"
          echo "=================================================="
